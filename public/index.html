<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bluebeam API Demo Dashboard</title>
  <link rel="icon" type="image/png" href="/dashboard.png" />

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
  />

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f7f8fa;
    }

    header {
      background-color: #1a5aff;
      color: white;
      padding: 14px 24px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
    }

    /* ------------------- TAB BAR ------------------- */
    .tabs {
      display: flex;
      background: #ffffff;
      border-bottom: 1px solid #ddd;
    }

    .tab {
      padding: 12px 20px;
      font-size: 15px;
      cursor: pointer;
      border: none;
      background: transparent;
      border-right: 1px solid #eee;
      transition: 0.2s;
    }

    .tab:hover {
      background: #eef3ff;
    }

    .tab.active {
      background: #1a5aff;
      color: white;
      font-weight: bold;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* -------------- Markup Dashboard Styles -------------- */

    .controls {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 24px;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }

    #refresh {
      padding: 10px 20px;
      background-color: #1a5aff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #lastUpdated {
      color: #444;
      font-size: 14px;
    }

    .content {
      padding: 0 24px 40px;
    }

    details {
      background: #fff;
      padding: 12px 16px;
      margin-top: 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    summary {
      font-weight: 600;
      cursor: pointer;
      color: #1a5aff;
    }

    .chart-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 20px;
      margin-top: 20px;
    }

    .chart-container {
      flex: 1 1 48%;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    canvas {
      max-height: 320px;
      width: 100%;
    }

    table.dataTable thead th {
      background-color: #f5f5f5;
    }

    /* -------------- Session Closeout Styles -------------- */

    .closeout-input-row {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .closeout-input-label {
      font-size: 14px;
      color: #333;
    }

    .btn-blue {
      padding: 8px 14px;
      background: #1a5aff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-blue:disabled {
      background: #999;
      cursor: not-allowed;
    }

    /* -------------- Progress Modal Styles -------------- */

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: #ffffff;
      padding: 20px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      width: 320px;
    }

    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .progress-list {
      list-style: none;
      padding-left: 0;
      margin: 12px 0;
    }

    .progress-list li {
      font-size: 14px;
      margin-bottom: 4px;
    }

    .progress-list li.pending::before {
      content: "‚è≥ ";
    }

    .progress-list li.done::before {
      content: "‚úÖ ";
    }

    .progress-message {
      font-size: 13px;
      color: #555;
      margin-top: 8px;
    }

    .error-text {
      color: #b00020;
      font-size: 13px;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <h1>Bluebeam API Demo Dashboard</h1>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-target="#tab-markups">
      üìù Markup API Dashboard
    </button>
    <button class="tab" data-target="#tab-closeout">
      üìÅ Session File Closeout
    </button>
  </div>

  <!-- TAB CONTENT 1: MARKUP API DASHBOARD -->
  <div id="tab-markups" class="tab-content active">
    <div class="controls">
      <button id="refresh">üîÑ Refresh Data</button>
      <div id="lastUpdated">Last updated: ‚Äî</div>
    </div>

    <div class="content">
      <!-- Collapsible Instructions -->
      <details open>
        <summary>‚ÑπÔ∏è How to Use This Demo</summary>
        <p>
          This dashboard visualizes real-time data pulled from the
          <strong>Bluebeam Markup API</strong> using Session
          <strong>515-659-145</strong>.
        </p>
        <ul>
          <li>Click <strong>Refresh Data</strong> to pull the latest markups.</li>
          <li>View workflow stages, trends over time, and activity summaries.</li>
          <li>Use the sortable table to explore all markups.</li>
        </ul>
      </details>

      <!-- Top Row -->
      <div class="chart-row">
        <div class="chart-container">
          <h2>üïì Recent Activity (Past 24 Hours)</h2>
          <table id="recentTable" class="display">
            <thead>
              <tr>
                <th>Author</th>
                <th>Comments</th>
                <th>Status</th>
                <th>Time (EST)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="chart-container">
          <canvas id="statusChart"></canvas>
        </div>
      </div>

      <h2 style="margin-top: 40px">üìÑ All Markups</h2>
      <table id="markupTable" class="display">
        <thead>
          <tr>
            <th>Author</th>
            <th>Comments</th>
            <th>Status</th>
            <th>Page</th>
            <th>Date Created (EST)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="chart-row">
        <div class="chart-container">
          <canvas id="activityChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB CONTENT 2: SESSION FILE CLOSEOUT -->
  <div id="tab-closeout" class="tab-content">
    <div class="content">
      <h2>üìÅ Session File Closeout Demo</h2>
      <p>
        This demo uses a fixed Session (<strong>693-759-210</strong>) and
        Project (<strong>564-177-023</strong>) to show how you can automate:
        updating the project copy, removing a file from the session, and
        checking it back in with a single click.
      </p>

      <div class="closeout-input-row">
        <span class="closeout-input-label">
          Using Session ID: <strong>693-759-210</strong>
        </span>
        <button id="loadSessionFiles" class="btn-blue">Load Files</button>
      </div>

      <table
        id="sessionFilesTable"
        class="display"
        style="margin-top: 20px; width: 100%"
      >
        <thead>
          <tr>
            <th>File Name</th>
            <th>Session File ID</th>
            <th>Project File ID</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Progress Modal -->
  <div id="progressModal" class="modal-overlay">
    <div class="modal-content">
      <h3>Closing Out File</h3>
      <ul class="progress-list">
        <li id="step-update" class="pending">1. Update project copy</li>
        <li id="step-remove" class="pending">2. Remove file from session</li>
        <li id="step-checkin" class="pending">3. Check file back into project</li>
      </ul>
      <div id="progressMessage" class="progress-message">
        Running closeout steps‚Ä¶
      </div>
      <div id="progressError" class="error-text" style="display: none"></div>
      <button
        id="modalCloseBtn"
        class="btn-blue"
        style="display: none; margin-top: 12px"
      >
        Close
      </button>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script>
    /* ---------------- TAB SWITCHING ---------------- */
    document.addEventListener('DOMContentLoaded', () => {
      const tabs = document.querySelectorAll('.tab');
      const contents = document.querySelectorAll('.tab-content');

      tabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          tabs.forEach((t) => t.classList.remove('active'));
          contents.forEach((c) => c.classList.remove('active'));

          tab.classList.add('active');
          const target = document.querySelector(tab.dataset.target);
          target.classList.add('active');
        });
      });
    });

    /* ---------------- MARKUP DASHBOARD ---------------- */

    const API_URL = '/powerbi/markups';
    const refreshBtn = document.getElementById('refresh');
    const lastUpdated = document.getElementById('lastUpdated');
    const ctxStatus = document.getElementById('statusChart').getContext('2d');
    const ctxActivity = document
      .getElementById('activityChart')
      .getContext('2d');

    let statusChart, activityChart, dataTable, recentTable;

    function formatEST(dateString) {
      return new Date(dateString).toLocaleString('en-US', {
        timeZone: 'America/New_York'
      });
    }

    async function fetchAndRender() {
      refreshBtn.disabled = true;
      refreshBtn.innerText = 'Loading...';

      try {
        const res = await fetch(API_URL);
        const data = await res.json();

        if (!Array.isArray(data)) {
          console.error('Unexpected response:', data);
          alert('Error loading data. Check console.');
          return;
        }

        const now = new Date();
        const past24h = data.filter(
          (m) => now - new Date(m.DateCreated) < 24 * 60 * 60 * 1000
        );

        /* Recent Table */
        if (recentTable) recentTable.clear().destroy();
        const recentBody = document.querySelector('#recentTable tbody');
        recentBody.innerHTML = '';
        past24h.forEach((m) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${m.Author || '-'}</td>
            <td>${m.Comments || '-'}</td>
            <td>${m.Status || '-'}</td>
            <td>${formatEST(m.DateCreated)}</td>
          `;
          recentBody.appendChild(row);
        });
        recentTable = new DataTable('#recentTable', {
          order: [[3, 'desc']],
          pageLength: 5
        });

        /* All Markups Table */
        if (dataTable) dataTable.clear().destroy();
        const tableBody = document.querySelector('#markupTable tbody');
        tableBody.innerHTML = '';
        data.forEach((m) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${m.Author || '-'}</td>
            <td>${m.Comments || '-'}</td>
            <td>${m.Status || '-'}</td>
            <td>${m.Page || '-'}</td>
            <td>${formatEST(m.DateCreated)}</td>
          `;
          tableBody.appendChild(row);
        });
        dataTable = new DataTable('#markupTable', {
          order: [[4, 'desc']],
          pageLength: 25
        });

        /* Pie Chart */
        const statusCounts = {};
        data.forEach((m) => {
          const status = m.Status || 'Unknown';
          statusCounts[status] = (statusCounts[status] || 0) + 1;
        });

        const statusLabels = Object.keys(statusCounts);
        const statusValues = Object.values(statusCounts);

        if (statusChart) statusChart.destroy();
        statusChart = new Chart(ctxStatus, {
          type: 'pie',
          data: {
            labels: statusLabels,
            datasets: [
              {
                data: statusValues,
                backgroundColor: [
                  '#1A5AFF',
                  '#00B8A9',
                  '#F9ED69',
                  '#F08A5D',
                  '#B83B5E'
                ]
              }
            ]
          },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });

        /* Activity Chart */
        const countsByDay = {};
        data.forEach((m) => {
          const day = new Date(m.DateCreated).toLocaleDateString('en-US', {
            timeZone: 'America/New_York'
          });
          countsByDay[day] = (countsByDay[day] || 0) + 1;
        });

        if (activityChart) activityChart.destroy();
        activityChart = new Chart(ctxActivity, {
          type: 'line',
          data: {
            labels: Object.keys(countsByDay),
            datasets: [
              {
                label: 'Markups per Day',
                data: Object.values(countsByDay),
                borderColor: '#1A5AFF',
                tension: 0.3
              }
            ]
          }
        });

        lastUpdated.textContent = `Last updated: ${formatEST(new Date())}`;
      } catch (err) {
        alert('Failed to load data.');
        console.error(err);
      }

      refreshBtn.disabled = false;
      refreshBtn.innerText = 'üîÑ Refresh Data';
    }

    refreshBtn.addEventListener('click', fetchAndRender);
    window.addEventListener('DOMContentLoaded', fetchAndRender);

    /* ---------------- SESSION FILE CLOSEOUT ---------------- */

    const loadBtn = document.getElementById('loadSessionFiles');
    const sessionTableBody = document.querySelector(
      '#sessionFilesTable tbody'
    );

    const progressModal = document.getElementById('progressModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const stepUpdate = document.getElementById('step-update');
    const stepRemove = document.getElementById('step-remove');
    const stepCheckin = document.getElementById('step-checkin');
    const progressMessage = document.getElementById('progressMessage');
    const progressError = document.getElementById('progressError');

    function resetProgressModal() {
      [stepUpdate, stepRemove, stepCheckin].forEach((li) => {
        li.classList.remove('done');
        li.classList.add('pending');
      });
      progressMessage.textContent = 'Running closeout steps‚Ä¶';
      progressError.style.display = 'none';
      progressError.textContent = '';
      modalCloseBtn.style.display = 'none';
    }

    function openProgressModal() {
      resetProgressModal();
      progressModal.classList.add('active');
    }

    function closeProgressModal() {
      progressModal.classList.remove('active');
    }

    modalCloseBtn.addEventListener('click', closeProgressModal);

    if (loadBtn) {
      loadBtn.addEventListener('click', async () => {
        try {
          loadBtn.disabled = true;
          loadBtn.textContent = 'Loading...';

          const res = await fetch('/api/closeout/files');
          const files = await res.json();

          sessionTableBody.innerHTML = '';

          files.forEach((f) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${f.fileName}</td>
              <td>${f.sessionFileId}</td>
              <td>${f.projectFileId || '-'}</td>
              <td>
                <button class="closeoutBtn btn-blue"
                        data-sessionfile="${f.sessionFileId}"
                        data-projectfile="${f.projectFileId || ''}">
                  Close Out
                </button>
              </td>
            `;
            sessionTableBody.appendChild(row);
          });

          document.querySelectorAll('.closeoutBtn').forEach((btn) => {
            btn.addEventListener('click', async () => {
              const sessionFileId = btn.dataset.sessionfile;
              const projectFileId = btn.dataset.projectfile;

              if (!projectFileId) {
                alert(
                  'No Project File ID found for this file. Verify your Session ‚Üí Project mapping.'
                );
                return;
              }

              btn.disabled = true;
              btn.textContent = 'Processing...';

              openProgressModal();

              try {
                const resp = await fetch('/api/closeout-file', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ sessionFileId, projectFileId })
                });

                if (resp.ok) {
                  // mark all steps as done (backend performed all in sequence)
                  [stepUpdate, stepRemove, stepCheckin].forEach((li) => {
                    li.classList.remove('pending');
                    li.classList.add('done');
                  });
                  progressMessage.textContent =
                    'File successfully closed out and checked in.';
                  btn.textContent = '‚úî Done';
                  modalCloseBtn.style.display = 'inline-block';
                } else {
                  const err = await resp.json().catch(() => ({}));
                  progressMessage.textContent = 'Closeout failed.';
                  progressError.style.display = 'block';
                  progressError.textContent =
                    err.error || 'Unknown error. Check server logs.';
                  btn.textContent = 'Error';
                  btn.disabled = false;
                  modalCloseBtn.style.display = 'inline-block';
                }
              } catch (e) {
                console.error(e);
                progressMessage.textContent = 'Closeout failed.';
                progressError.style.display = 'block';
                progressError.textContent =
                  e.message || 'Unknown error. Check server logs.';
                btn.textContent = 'Error';
                btn.disabled = false;
                modalCloseBtn.style.display = 'inline-block';
              }
            });
          });
        } catch (err) {
          console.error('Error loading session files:', err);
          alert('Failed to load session files. Check console.');
        } finally {
          loadBtn.disabled = false;
          loadBtn.textContent = 'Load Files';
        }
      });
    }
  </script>
</body>
</html>
