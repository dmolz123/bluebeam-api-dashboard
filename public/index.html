<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bluebeam API Dashboard Demo</title>
  <link rel="icon" type="image/png" href="/dashboard.png">

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f7f8fa;
    }

    header {
      background-color: #1A5AFF;
      color: white;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 24px;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }

    #refresh {
      padding: 10px 20px;
      background-color: #1A5AFF;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #lastUpdated {
      color: #444;
      font-size: 14px;
    }

    .content {
      padding: 0 24px 40px;
    }

    h2 {
      margin-top: 40px;
      font-size: 18px;
      color: #333;
    }

    table.dataTable thead th {
      background-color: #f5f5f5;
    }

    .chart-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 20px;
      margin-top: 20px;
    }

    .chart-container {
      flex: 1 1 48%;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    canvas {
      max-height: 320px;
      width: 100%;
    }
  </style>
</head>
<body>

  <header>
    <div class="header-left">
      <h1>Bluebeam API Dashboard Demo</h1>
    </div>
  </header>

  <div class="controls">
    <button id="refresh">ðŸ”„ Refresh Data</button>
    <div id="lastUpdated">Last updated: â€”</div>
  </div>

  <div class="content">
    <!-- Recent Activity -->
    <h2>ðŸ•“ Recent Activity (Past 24 Hours)</h2>
    <table id="recentTable" class="display">
      <thead>
        <tr>
          <th>Author</th>
          <th>Comments</th>
          <th>Status</th>
          <th>Time (EST)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="chart-row">
      <div class="chart-container">
        <canvas id="statusChart"></canvas>
      </div>
    </div>

    <!-- All Markups -->
    <h2>ðŸ“„ All Markups</h2>
    <table id="markupTable" class="display">
      <thead>
        <tr>
          <th>Author</th>
          <th>Comments</th>
          <th>Status</th>
          <th>Page</th>
          <th>Date Created (EST)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="chart-row">
      <div class="chart-container">
        <canvas id="activityChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://bluebeam-api-dashboard.onrender.com/powerbi/markups';
    const refreshBtn = document.getElementById('refresh');
    const lastUpdated = document.getElementById('lastUpdated');
    const ctxStatus = document.getElementById('statusChart').getContext('2d');
    const ctxActivity = document.getElementById('activityChart').getContext('2d');

    let statusChart, activityChart, dataTable, recentTable;

    function formatEST(dateString) {
      return new Date(dateString).toLocaleString('en-US', { timeZone: 'America/New_York' });
    }

    async function fetchAndRender() {
      refreshBtn.disabled = true;
      refreshBtn.innerText = 'Loading...';

      try {
        const res = await fetch(API_URL);
        const data = await res.json();

        if (!Array.isArray(data)) {
          console.error('Unexpected response:', data);
          alert('Error loading data. Check console.');
          return;
        }

        const now = new Date();
        const past24h = data.filter(m => (now - new Date(m.DateCreated)) < 24 * 60 * 60 * 1000);

        // ===== Recent Activity Table =====
        if (recentTable) recentTable.clear().destroy();
        const recentBody = document.querySelector('#recentTable tbody');
        recentBody.innerHTML = '';
        past24h.forEach(m => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${m.Author || '-'}</td>
            <td>${m.Comments || '-'}</td>
            <td>${m.Status || '-'}</td>
            <td>${formatEST(m.DateCreated)}</td>
          `;
          recentBody.appendChild(row);
        });
        recentTable = new DataTable('#recentTable', { order: [[3, 'desc']], pageLength: 5 });

        // ===== All Markups Table =====
        if (dataTable) dataTable.clear().destroy();
        const tableBody = document.querySelector('#markupTable tbody');
        tableBody.innerHTML = '';
        data.forEach(m => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${m.Author || '-'}</td>
            <td>${m.Comments || '-'}</td>
            <td>${m.Status || '-'}</td>
            <td>${m.Page || '-'}</td>
            <td>${formatEST(m.DateCreated)}</td>
          `;
          tableBody.appendChild(row);
        });
        dataTable = new DataTable('#markupTable', { order: [[4, 'desc']], pageLength: 25 });

        // ===== Chart 1: Markups by Status (Pie) =====
        const statusCounts = {};
        data.forEach(m => {
          const status = m.Status || 'Unknown';
          statusCounts[status] = (statusCounts[status] || 0) + 1;
        });
        const statusLabels = Object.keys(statusCounts);
        const statusValues = Object.values(statusCounts);

        if (statusChart) statusChart.destroy();
        statusChart = new Chart(ctxStatus, {
          type: 'pie',
          data: {
            labels: statusLabels,
            datasets: [{
              data: statusValues,
              backgroundColor: ['#1A5AFF', '#00B8A9', '#F9ED69', '#F08A5D', '#B83B5E']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: 'Markups by Status' },
              legend: { position: 'bottom' }
            }
          }
        });

        // ===== Chart 2: Markup Activity Over Time (Line) =====
        const countsByDay = {};
        data.forEach(m => {
          const day = new Date(m.DateCreated).toLocaleDateString('en-US', { timeZone: 'America/New_York' });
          countsByDay[day] = (countsByDay[day] || 0) + 1;
        });

        const labels = Object.keys(countsByDay);
        const values = Object.values(countsByDay);

        if (activityChart) activityChart.destroy();
        activityChart = new Chart(ctxActivity, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Markups per Day',
              data: values,
              fill: false,
              borderColor: '#1A5AFF',
              tension: 0.3,
              pointRadius: 4,
              pointBackgroundColor: '#1A5AFF'
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: 'Markup Activity Over Time' },
              legend: { display: false }
            },
            scales: {
              x: { title: { display: true, text: 'Date (EST)' } },
              y: { title: { display: true, text: 'Count' }, beginAtZero: true, ticks: { stepSize: 1 } }
            }
          }
        });

        // ===== Update timestamp =====
        const updated = new Date();
        lastUpdated.textContent = `Last updated: ${formatEST(updated)}`;

      } catch (err) {
        alert('Failed to load data.');
        console.error(err);
      }

      refreshBtn.disabled = false;
      refreshBtn.innerText = 'ðŸ”„ Refresh Data';
    }

    refreshBtn.addEventListener('click', fetchAndRender);
    window.addEventListener('DOMContentLoaded', fetchAndRender);
  </script>
</body>
</html>
